<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待办事项功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .success { border-color: #4CAF50; background-color: #f8fff8; }
        .error { border-color: #f44336; background-color: #fff8f8; }
        .info { border-color: #2196F3; background-color: #f8f9ff; }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #005a8b; }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🔧 AI笔记本待办事项功能测试</h1>
    
    <div class="test-section info">
        <h2>📋 测试概述</h2>
        <p>此页面用于测试待办事项功能的各个组件是否正常工作。</p>
        <p><strong>前端地址：</strong> <a href="http://localhost:5174" target="_blank">http://localhost:5174</a></p>
        <p><strong>后端地址：</strong> <a href="http://localhost:8000" target="_blank">http://localhost:8000</a></p>
    </div>

    <div class="test-section">
        <h2>🔗 1. 服务器连接测试</h2>
        <button onclick="testServers()">测试服务器状态</button>
        <div id="server-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>🔐 2. 用户登录测试</h2>
        <input type="email" id="email" placeholder="邮箱" value="test@example.com">
        <input type="password" id="password" placeholder="密码" value="password123">
        <button onclick="testLogin()">测试登录</button>
        <div id="login-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>📝 3. 笔记获取测试</h2>
        <button onclick="testNotes()">获取笔记列表</button>
        <div id="notes-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>✅ 4. 待办事项解析测试</h2>
        <textarea id="todo-content" rows="6" cols="60" placeholder="输入包含待办事项的Markdown内容">
# 测试笔记

## 待办事项
- [ ] 完成项目报告 !high @明天 #张三
- [x] 完成代码审查 !medium @今天
- [ ] 准备会议材料 !low @下周 #团队

## 其他内容
这是一些普通的文本内容。
        </textarea>
        <br>
        <button onclick="testTodoParsing()">测试待办解析</button>
        <div id="todo-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>🎯 5. 组件加载测试</h2>
        <button onclick="testComponentLoading()">检查前端组件</button>
        <div id="component-result" class="result"></div>
    </div>

    <script>
        let authToken = '';

        async function testServers() {
            const result = document.getElementById('server-result');
            result.innerHTML = '正在测试服务器连接...\n';

            try {
                // 测试前端
                const frontendResponse = await fetch('http://localhost:5174/', { method: 'HEAD' });
                result.innerHTML += `前端服务器 (5174): ${frontendResponse.ok ? '✅ 正常' : '❌ 异常'}\n`;
                
                // 测试后端
                const backendResponse = await fetch('http://localhost:8000/health');
                const backendData = await backendResponse.json();
                result.innerHTML += `后端服务器 (8000): ${backendResponse.ok ? '✅ 正常' : '❌ 异常'}\n`;
                result.innerHTML += `后端响应: ${JSON.stringify(backendData, null, 2)}\n`;
            } catch (error) {
                result.innerHTML += `❌ 连接错误: ${error.message}\n`;
            }
        }

        async function testLogin() {
            const result = document.getElementById('login-result');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            result.innerHTML = '正在测试登录...\n';

            try {
                const response = await fetch('http://localhost:8000/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    result.innerHTML += `✅ 登录成功\n`;
                    result.innerHTML += `Token: ${authToken.substring(0, 50)}...\n`;
                } else {
                    result.innerHTML += `❌ 登录失败: ${data.detail}\n`;
                }
            } catch (error) {
                result.innerHTML += `❌ 登录错误: ${error.message}\n`;
            }
        }

        async function testNotes() {
            const result = document.getElementById('notes-result');
            
            if (!authToken) {
                result.innerHTML = '❌ 请先登录获取token\n';
                return;
            }

            result.innerHTML = '正在获取笔记列表...\n';

            try {
                const response = await fetch('http://localhost:8000/notes/', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.innerHTML += `✅ 获取成功，共 ${data.length} 篇笔记\n`;
                    result.innerHTML += `笔记列表:\n${JSON.stringify(data, null, 2)}\n`;
                } else {
                    result.innerHTML += `❌ 获取失败: ${data.detail}\n`;
                }
            } catch (error) {
                result.innerHTML += `❌ 请求错误: ${error.message}\n`;
            }
        }

        function testTodoParsing() {
            const result = document.getElementById('todo-result');
            const content = document.getElementById('todo-content').value;
            
            result.innerHTML = '正在解析待办事项...\n';

            try {
                // 模拟前端的待办事项解析逻辑
                const todoRegex = /^(\s*)-\s*\[([x\s])\]\s*(.+)$/gm;
                const todos = [];
                let match;

                while ((match = todoRegex.exec(content)) !== null) {
                    const [fullMatch, indent, checked, task] = match;
                    
                    // 解析任务属性
                    let cleanTask = task;
                    let priority = null;
                    let dueDate = null;
                    let assignee = null;

                    // 提取优先级
                    const priorityMatch = cleanTask.match(/!\s*(high|medium|low)/i);
                    if (priorityMatch) {
                        priority = priorityMatch[1].toLowerCase();
                        cleanTask = cleanTask.replace(priorityMatch[0], '').trim();
                    }

                    // 提取截止日期
                    const dueDateMatch = cleanTask.match(/@\s*(\d{4}-\d{2}-\d{2}|今天|明天|下周)/);
                    if (dueDateMatch) {
                        dueDate = dueDateMatch[1];
                        cleanTask = cleanTask.replace(dueDateMatch[0], '').trim();
                    }

                    // 提取负责人
                    const assigneeMatch = cleanTask.match(/#\s*([^\s]+)/);
                    if (assigneeMatch) {
                        assignee = assigneeMatch[1];
                        cleanTask = cleanTask.replace(assigneeMatch[0], '').trim();
                    }

                    todos.push({
                        checked: checked === 'x',
                        task: cleanTask,
                        priority,
                        dueDate,
                        assignee,
                        raw: fullMatch
                    });
                }

                result.innerHTML += `✅ 解析成功，找到 ${todos.length} 个待办事项\n`;
                result.innerHTML += `解析结果:\n${JSON.stringify(todos, null, 2)}\n`;
                
                // 统计信息
                const completed = todos.filter(t => t.checked).length;
                const pending = todos.length - completed;
                result.innerHTML += `\n📊 统计信息:\n`;
                result.innerHTML += `总计: ${todos.length}\n`;
                result.innerHTML += `已完成: ${completed}\n`;
                result.innerHTML += `待完成: ${pending}\n`;

            } catch (error) {
                result.innerHTML += `❌ 解析错误: ${error.message}\n`;
            }
        }

        function testComponentLoading() {
            const result = document.getElementById('component-result');
            result.innerHTML = '正在检查前端组件...\n';

            // 检查前端页面是否可访问
            const iframe = document.createElement('iframe');
            iframe.src = 'http://localhost:5174';
            iframe.style.display = 'none';
            
            iframe.onload = function() {
                result.innerHTML += '✅ 前端页面加载成功\n';
                result.innerHTML += '建议：\n';
                result.innerHTML += '1. 在浏览器中打开 http://localhost:5174\n';
                result.innerHTML += '2. 打开开发者工具查看控制台错误\n';
                result.innerHTML += '3. 检查Network标签页的网络请求\n';
                result.innerHTML += '4. 如果页面空白，可能是React组件渲染问题\n';
                document.body.removeChild(iframe);
            };

            iframe.onerror = function() {
                result.innerHTML += '❌ 前端页面加载失败\n';
                result.innerHTML += '请检查前端服务器是否正常运行\n';
                document.body.removeChild(iframe);
            };

            document.body.appendChild(iframe);
        }

        // 页面加载时自动运行服务器测试
        window.onload = function() {
            testServers();
        };
    </script>
</body>
</html>
