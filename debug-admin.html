<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜åŠŸèƒ½è¯Šæ–­</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .check-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ddd;
        }
        .check-item.success {
            background: #d1fae5;
            border-color: #10b981;
        }
        .check-item.error {
            background: #fee2e2;
            border-color: #ef4444;
        }
        .check-item.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        .code {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
        }
        button {
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        button:hover {
            background: #4338ca;
        }
        .info {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            color: #1e40af;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç®¡ç†å‘˜åŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
        
        <div class="info">
            ğŸ“Œ æ­¤å·¥å…·å¸®åŠ©ä½ è¯Šæ–­ä¸ºä»€ä¹ˆçœ‹ä¸åˆ°ç®¡ç†å‘˜åŠŸèƒ½
        </div>

        <button onclick="runDiagnostic()">ğŸš€ å¼€å§‹è¯Šæ–­</button>
        <button onclick="clearCache()">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•</button>

        <div id="results"></div>
    </div>

    <script>
        function runDiagnostic() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>è¯Šæ–­ç»“æœ</h2>';

            // æ£€æŸ¥ 1: localStorage ä¸­çš„ç”¨æˆ·ä¿¡æ¯
            const userStr = localStorage.getItem('user');
            const user = userStr ? JSON.parse(userStr) : null;

            if (user) {
                results.innerHTML += `
                    <div class="check-item ${user.role === 'admin' ? 'success' : 'error'}">
                        <strong>âœ“ æ£€æŸ¥ 1: localStorage ç”¨æˆ·ä¿¡æ¯</strong>
                        <div class="code">
é‚®ç®±: ${user.email}
è§’è‰²: ${user.role}
ID: ${user.id}
                        </div>
                        ${user.role === 'admin' 
                            ? '<p>âœ… è§’è‰²æ­£ç¡®ï¼Œä½ æ˜¯ç®¡ç†å‘˜ï¼</p>' 
                            : '<p>âŒ è§’è‰²é”™è¯¯ï¼šå½“å‰æ˜¯ "' + user.role + '"ï¼Œéœ€è¦æ˜¯ "admin"<br>ğŸ‘‰ è¯·é‡æ–°ç™»å½•æˆ–æ£€æŸ¥ Supabase æ•°æ®åº“</p>'
                        }
                    </div>
                `;
            } else {
                results.innerHTML += `
                    <div class="check-item error">
                        <strong>âŒ æ£€æŸ¥ 1: æœªç™»å½•</strong>
                        <p>æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•</p>
                    </div>
                `;
            }

            // æ£€æŸ¥ 2: Token
            const token = localStorage.getItem('token');
            results.innerHTML += `
                <div class="check-item ${token ? 'success' : 'error'}">
                    <strong>${token ? 'âœ“' : 'âŒ'} æ£€æŸ¥ 2: è®¤è¯ Token</strong>
                    <p>${token ? 'âœ… Token å­˜åœ¨' : 'âŒ Token ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°ç™»å½•'}</p>
                    ${token ? '<div class="code">' + token.substring(0, 50) + '...</div>' : ''}
                </div>
            `;

            // æ£€æŸ¥ 3: API è¿æ¥
            results.innerHTML += `
                <div class="check-item warning">
                    <strong>â³ æ£€æŸ¥ 3: API è¿æ¥æµ‹è¯•</strong>
                    <p>æ­£åœ¨æµ‹è¯•...</p>
                </div>
            `;

            testAPI(user, token, results);

            // æ£€æŸ¥ 4: å‰ç«¯ç‰ˆæœ¬
            checkFrontendVersion(results);
        }

        async function testAPI(user, token, results) {
            if (!token) {
                return;
            }

            try {
                const response = await fetch('https://my-ai-notebook-production.up.railway.app/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();
                
                const apiCheckHtml = `
                    <div class="check-item ${response.ok && data.role === 'admin' ? 'success' : 'error'}">
                        <strong>${response.ok ? 'âœ“' : 'âŒ'} æ£€æŸ¥ 3: API è¿æ¥æµ‹è¯•</strong>
                        ${response.ok ? `
                            <div class="code">
API è¿”å›è§’è‰²: ${data.role}
API è¿”å›é‚®ç®±: ${data.email}
                            </div>
                            <p>${data.role === 'admin' 
                                ? 'âœ… API ç¡®è®¤ä½ æ˜¯ç®¡ç†å‘˜ï¼' 
                                : 'âŒ API æ˜¾ç¤ºä½ ä¸æ˜¯ç®¡ç†å‘˜ï¼Œè¯·æ£€æŸ¥ Supabase æ•°æ®åº“è®¾ç½®'
                            }</p>
                        ` : `
                            <p>âŒ API è¿æ¥å¤±è´¥: ${data.detail || 'æœªçŸ¥é”™è¯¯'}</p>
                        `}
                    </div>
                `;
                
                // æ›´æ–°æ£€æŸ¥3çš„ç»“æœ
                const checks = results.querySelectorAll('.check-item');
                checks[2].outerHTML = apiCheckHtml;

                // å¦‚æœ localStorage å’Œ API ä¸ä¸€è‡´
                if (user && data.role !== user.role) {
                    results.innerHTML += `
                        <div class="check-item error">
                            <strong>âš ï¸ æ•°æ®ä¸ä¸€è‡´</strong>
                            <p>localStorage ä¸­è§’è‰²æ˜¯ "${user.role}"<br>
                            ä½† API è¿”å›è§’è‰²æ˜¯ "${data.role}"</p>
                            <p><strong>ğŸ‘‰ è§£å†³æ–¹æ¡ˆï¼šæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•</strong></p>
                        </div>
                    `;
                }
            } catch (error) {
                const checks = results.querySelectorAll('.check-item');
                checks[2].outerHTML = `
                    <div class="check-item error">
                        <strong>âŒ æ£€æŸ¥ 3: API è¿æ¥å¤±è´¥</strong>
                        <p>é”™è¯¯: ${error.message}</p>
                        <p>åç«¯ URL: https://my-ai-notebook-production.up.railway.app</p>
                    </div>
                `;
            }
        }

        function checkFrontendVersion(results) {
            // æ£€æŸ¥å‰ç«¯æ˜¯å¦æœ‰ AdminDashboard
            const hasAdminDashboard = !!window.AdminDashboard || 
                                     document.querySelector('[data-component="admin-dashboard"]');
            
            results.innerHTML += `
                <div class="check-item ${hasAdminDashboard ? 'success' : 'warning'}">
                    <strong>ğŸ“¦ æ£€æŸ¥ 4: å‰ç«¯ä»£ç ç‰ˆæœ¬</strong>
                    <p>${hasAdminDashboard 
                        ? 'âœ… å‰ç«¯åŒ…å«ç®¡ç†å‘˜ç»„ä»¶' 
                        : 'âš ï¸ æ— æ³•ç¡®è®¤ç®¡ç†å‘˜ç»„ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰'
                    }</p>
                    <p>æœ€åæ›´æ–°: ${document.lastModified}</p>
                </div>
            `;

            // æ€»ç»“
            results.innerHTML += `
                <div class="info" style="margin-top: 30px;">
                    <h3>ğŸ’¡ å¸¸è§è§£å†³æ–¹æ¡ˆ</h3>
                    <ol>
                        <li><strong>é‡æ–°ç™»å½•</strong>ï¼ˆæœ€å¸¸è§ï¼‰- ç‚¹å‡»ä¸Šæ–¹"æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•"æŒ‰é’®</li>
                        <li><strong>æ£€æŸ¥ Supabase</strong> - ç¡®è®¤æ•°æ®åº“ä¸­ role å­—æ®µç¡®å®æ˜¯ "admin"</li>
                        <li><strong>ç­‰å¾…éƒ¨ç½²</strong> - ç¡®è®¤ Vercel æœ€æ–°éƒ¨ç½²å·²å®Œæˆ</li>
                        <li><strong>å¼ºåˆ¶åˆ·æ–°</strong> - Cmd+Shift+R (Mac) æˆ– Ctrl+Shift+R (Windows)</li>
                    </ol>
                </div>
            `;
        }

        function clearCache() {
            if (confirm('è¿™å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°æ•°æ®å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œç¡®å®šå—ï¼Ÿ')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('ç¼“å­˜å·²æ¸…é™¤ï¼ç°åœ¨å°†è·³è½¬åˆ°ç™»å½•é¡µé¢...');
                window.location.href = 'https://ai-notebook-production.vercel.app';
            }
        }
    </script>
</body>
</html>

