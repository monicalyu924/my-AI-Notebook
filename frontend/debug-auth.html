<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        input, button { padding: 10px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #007bff; color: white; cursor: pointer; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” Authentication Debug Tool</h1>
    
    <div class="test-section">
        <h2>1. åç«¯è¿æ¥æµ‹è¯•</h2>
        <button onclick="testBackendConnection()">æµ‹è¯•åç«¯è¿æ¥</button>
        <div id="backend-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>2. ç”¨æˆ·æ³¨å†Œæµ‹è¯•</h2>
        <input type="email" id="reg-email" placeholder="é‚®ç®±" value="debug@test.com">
        <input type="password" id="reg-password" placeholder="å¯†ç " value="debug123456">
        <input type="text" id="reg-name" placeholder="å§“å" value="Debug User">
        <button onclick="testRegister()">æµ‹è¯•æ³¨å†Œ</button>
        <div id="register-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>3. ç”¨æˆ·ç™»å½•æµ‹è¯•</h2>
        <input type="email" id="login-email" placeholder="é‚®ç®±" value="test@example.com">
        <input type="password" id="login-password" placeholder="å¯†ç " value="testpassword123">
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <div id="login-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>4. å‰ç«¯åº”ç”¨çŠ¶æ€</h2>
        <button onclick="checkFrontendStatus()">æ£€æŸ¥å‰ç«¯çŠ¶æ€</button>
        <div id="frontend-result" class="log"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        async function testBackendConnection() {
            const resultId = 'backend-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                log(resultId, 'æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...', 'info');
                
                // æµ‹è¯•æ–‡æ¡£ç«¯ç‚¹
                const docsResponse = await fetch(`${API_BASE}/docs`);
                if (docsResponse.ok) {
                    log(resultId, 'âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ', 'success');
                } else {
                    log(resultId, `âŒ æ–‡æ¡£ç«¯ç‚¹å¤±è´¥: ${docsResponse.status}`, 'error');
                }
                
                // æµ‹è¯• OpenAPI schema
                const openApiResponse = await fetch(`${API_BASE}/openapi.json`);
                if (openApiResponse.ok) {
                    const schema = await openApiResponse.json();
                    log(resultId, `âœ… API Schema åŠ è½½æˆåŠŸ (${Object.keys(schema.paths).length} ä¸ªç«¯ç‚¹)`, 'success');
                    
                    // æ˜¾ç¤ºè®¤è¯ç›¸å…³ç«¯ç‚¹
                    const authEndpoints = Object.keys(schema.paths).filter(path => path.includes('/auth'));
                    log(resultId, `è®¤è¯ç«¯ç‚¹: ${authEndpoints.join(', ')}`, 'info');
                } else {
                    log(resultId, 'âŒ OpenAPI schema åŠ è½½å¤±è´¥', 'error');
                }
                
            } catch (error) {
                log(resultId, `âŒ è¿æ¥é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testRegister() {
            const resultId = 'register-result';
            document.getElementById(resultId).innerHTML = '';
            
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const fullName = document.getElementById('reg-name').value;
            
            try {
                log(resultId, `æ­£åœ¨æ³¨å†Œç”¨æˆ·: ${email}`, 'info');
                
                const response = await fetch(`${API_BASE}/api/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        full_name: fullName
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(resultId, 'âœ… æ³¨å†ŒæˆåŠŸ!', 'success');
                    log(resultId, `è®¿é—®ä»¤ç‰Œ: ${data.access_token.substring(0, 20)}...`, 'success');
                } else {
                    log(resultId, `âŒ æ³¨å†Œå¤±è´¥: ${data.detail}`, 'error');
                }
                
            } catch (error) {
                log(resultId, `âŒ æ³¨å†Œè¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testLogin() {
            const resultId = 'login-result';
            document.getElementById(resultId).innerHTML = '';
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                log(resultId, `æ­£åœ¨ç™»å½•ç”¨æˆ·: ${email}`, 'info');
                
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    }),
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    log(resultId, 'âœ… ç™»å½•æˆåŠŸ!', 'success');
                    log(resultId, `è®¿é—®ä»¤ç‰Œ: ${data.access_token.substring(0, 20)}...`, 'success');
                    
                    // æµ‹è¯•è·å–ç”¨æˆ·èµ„æ–™
                    try {
                        const profileResponse = await fetch(`${API_BASE}/api/user/profile`, {
                            headers: {
                                'Authorization': `Bearer ${data.access_token}`,
                            },
                        });
                        
                        if (profileResponse.ok) {
                            const profile = await profileResponse.json();
                            log(resultId, `âœ… ç”¨æˆ·èµ„æ–™è·å–æˆåŠŸ: ${profile.full_name || profile.email}`, 'success');
                        } else {
                            log(resultId, `âš ï¸ ç”¨æˆ·èµ„æ–™è·å–å¤±è´¥: ${profileResponse.status}`, 'error');
                        }
                    } catch (profileError) {
                        log(resultId, `âš ï¸ ç”¨æˆ·èµ„æ–™è¯·æ±‚é”™è¯¯: ${profileError.message}`, 'error');
                    }
                    
                } else {
                    log(resultId, `âŒ ç™»å½•å¤±è´¥: ${data.detail}`, 'error');
                }
                
            } catch (error) {
                log(resultId, `âŒ ç™»å½•è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function checkFrontendStatus() {
            const resultId = 'frontend-result';
            document.getElementById(resultId).innerHTML = '';
            
            try {
                log(resultId, 'æ£€æŸ¥å‰ç«¯åº”ç”¨çŠ¶æ€...', 'info');
                
                // æ£€æŸ¥å‰ç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
                const frontendResponse = await fetch('http://localhost:5173');
                if (frontendResponse.ok) {
                    log(resultId, 'âœ… å‰ç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ (http://localhost:5173)', 'success');
                } else {
                    log(resultId, 'âŒ å‰ç«¯æœåŠ¡æ— æ³•è®¿é—®', 'error');
                }
                
                // æ£€æŸ¥ localStorage
                if (typeof Storage !== 'undefined') {
                    const token = localStorage.getItem('token');
                    if (token) {
                        log(resultId, `âœ… æœ¬åœ°å­˜å‚¨ä¸­æœ‰ä»¤ç‰Œ: ${token.substring(0, 20)}...`, 'success');
                    } else {
                        log(resultId, 'âš ï¸ æœ¬åœ°å­˜å‚¨ä¸­æ²¡æœ‰ä»¤ç‰Œ', 'info');
                    }
                } else {
                    log(resultId, 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ localStorage', 'error');
                }
                
                // æ£€æŸ¥ CORS
                log(resultId, 'æµ‹è¯• CORS é…ç½®...', 'info');
                const corsResponse = await fetch(`${API_BASE}/openapi.json`, {
                    method: 'GET',
                    headers: {
                        'Origin': 'http://localhost:5173'
                    }
                });
                
                if (corsResponse.ok) {
                    log(resultId, 'âœ… CORS é…ç½®æ­£å¸¸', 'success');
                } else {
                    log(resultId, 'âŒ CORS é…ç½®å¯èƒ½æœ‰é—®é¢˜', 'error');
                }
                
            } catch (error) {
                log(resultId, `âŒ æ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•åç«¯è¿æ¥
        window.addEventListener('load', () => {
            testBackendConnection();
        });
    </script>
</body>
</html>