<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸€é”®ä¿®å¤ç®¡ç†å‘˜åŠŸèƒ½</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container {
            background: white;
            max-width: 800px;
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .content {
            padding: 30px;
        }
        .step {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        .step h3 {
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-number {
            background: #667eea;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .step p {
            color: #666;
            line-height: 1.6;
            margin: 10px 0;
        }
        .code-box {
            background: #1a1a2e;
            color: #0ff;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 0;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        .success {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        .warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }
        .result {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        #finalResult {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            font-weight: 500;
        }
        .highlight {
            background: #fef3c7;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ ä¸€é”®ä¿®å¤ç®¡ç†å‘˜åŠŸèƒ½</h1>
            <p>è‡ªåŠ¨æ£€æµ‹å¹¶ä¿®å¤æ‰€æœ‰é—®é¢˜</p>
        </div>
        
        <div class="content">
            <div class="step warning">
                <h3>
                    <span>âš ï¸</span>
                    <span>é‡è¦æé†’</span>
                </h3>
                <p>1. ç¡®ä¿ä½ å·²ç»åœ¨ <span class="highlight">Supabase</span> ä¸­å°†è´¦å·è§’è‰²è®¾ç½®ä¸º admin</p>
                <p>2. ç¡®ä¿ <span class="highlight">Railway åç«¯</span> å’Œ <span class="highlight">Vercel å‰ç«¯</span> éƒ½å·²éƒ¨ç½²å®Œæˆ</p>
                <p>3. æ­¤å·¥å…·å°†æ¸…é™¤æ‰€æœ‰æœ¬åœ°ç¼“å­˜å¹¶é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯</p>
            </div>

            <button onclick="runFullDiagnostic()" style="background: #3b82f6;">
                ğŸ” ç¬¬1æ­¥: å®Œæ•´è¯Šæ–­
            </button>

            <div id="diagnosticResult" class="result"></div>

            <button onclick="fixIssues()" style="background: #10b981;">
                ğŸ”§ ç¬¬2æ­¥: è‡ªåŠ¨ä¿®å¤
            </button>

            <div id="fixResult" class="result"></div>

            <button onclick="verifyFix()" style="background: #8b5cf6;">
                âœ… ç¬¬3æ­¥: éªŒè¯ä¿®å¤
            </button>

            <div id="verifyResult" class="result"></div>

            <div id="finalResult"></div>

            <div class="step" style="margin-top: 30px;">
                <h3>
                    <span>ğŸ“</span>
                    <span>æ‰‹åŠ¨æ–¹æ³•ï¼ˆå¦‚æœè‡ªåŠ¨ä¿®å¤å¤±è´¥ï¼‰</span>
                </h3>
                <p><strong>åœ¨ Supabase SQL Editor è¿è¡Œï¼š</strong></p>
                <div class="code-box">UPDATE users 
SET role = 'admin' 
WHERE email = 'monicalyu24@163.com';

-- éªŒè¯
SELECT email, role FROM users WHERE email = 'monicalyu24@163.com';</div>
                <p><strong>ç„¶ååœ¨åº”ç”¨é¡µé¢ Console è¿è¡Œï¼š</strong></p>
                <div class="code-box">localStorage.clear();
sessionStorage.clear();
window.location.href = 'https://ai-notebook-production.vercel.app';</div>
            </div>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'https://my-ai-notebook-production.up.railway.app';
        const FRONTEND_URL = 'https://ai-notebook-production.vercel.app';

        let diagnosticData = {};

        async function runFullDiagnostic() {
            const resultDiv = document.getElementById('diagnosticResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>ğŸ” è¯Šæ–­ä¸­...</p>';

            let html = '<h3>è¯Šæ–­ç»“æœï¼š</h3>';
            let issues = [];

            // æ£€æŸ¥ 1: localStorage
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            const token = localStorage.getItem('token');

            html += '<div class="step">';
            if (user && user.role === 'admin') {
                html += '<p>âœ… localStorage ç”¨æˆ·è§’è‰²: <strong>admin</strong></p>';
                diagnosticData.localStorageOK = true;
            } else if (user) {
                html += `<p>âŒ localStorage ç”¨æˆ·è§’è‰²: <strong>${user.role}</strong> (åº”è¯¥æ˜¯ admin)</p>`;
                issues.push('localStorage è§’è‰²é”™è¯¯');
                diagnosticData.localStorageOK = false;
            } else {
                html += '<p>âŒ æœªç™»å½•</p>';
                issues.push('æœªç™»å½•');
                diagnosticData.localStorageOK = false;
            }
            html += '</div>';

            // æ£€æŸ¥ 2: API è¿æ¥
            if (token) {
                try {
                    const response = await fetch(`${BACKEND_URL}/api/auth/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });

                    html += '<div class="step">';
                    if (response.ok) {
                        const data = await response.json();
                        diagnosticData.apiUser = data;
                        
                        if (data.role === 'admin') {
                            html += '<p>âœ… API è¿”å›è§’è‰²: <strong>admin</strong></p>';
                            diagnosticData.apiOK = true;
                        } else {
                            html += `<p>âŒ API è¿”å›è§’è‰²: <strong>${data.role}</strong> (åº”è¯¥æ˜¯ admin)</p>`;
                            html += '<p>ğŸ‘‰ éœ€è¦åœ¨ Supabase ä¸­è®¾ç½®è§’è‰²ä¸º admin</p>';
                            issues.push('Supabase è§’è‰²æœªè®¾ç½®');
                            diagnosticData.apiOK = false;
                        }
                    } else {
                        html += `<p>âŒ API è¯·æ±‚å¤±è´¥: ${response.status}</p>`;
                        issues.push('API è¿æ¥å¤±è´¥');
                        diagnosticData.apiOK = false;
                    }
                    html += '</div>';
                } catch (error) {
                    html += '<div class="step">';
                    html += `<p>âŒ API è¿æ¥é”™è¯¯: ${error.message}</p>`;
                    if (error.message.includes('CORS')) {
                        html += '<p>ğŸ‘‰ CORS é”™è¯¯ï¼Œéœ€è¦ç­‰å¾… Railway åç«¯éƒ¨ç½²å®Œæˆ</p>';
                        issues.push('CORS é”™è¯¯');
                    }
                    diagnosticData.apiOK = false;
                    html += '</div>';
                }
            }

            // æ€»ç»“
            html += '<div class="step ' + (issues.length === 0 ? 'success' : 'error') + '">';
            if (issues.length === 0) {
                html += '<h3>ğŸ‰ æ­å–œï¼æ²¡æœ‰å‘ç°é—®é¢˜</h3>';
                html += '<p>è¯·ç‚¹å‡»"éªŒè¯ä¿®å¤"ç¡®è®¤ç®¡ç†å‘˜åŠŸèƒ½æ˜¯å¦å¯ç”¨</p>';
            } else {
                html += '<h3>âš ï¸ å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š</h3>';
                html += '<ul>';
                issues.forEach(issue => {
                    html += `<li>${issue}</li>`;
                });
                html += '</ul>';
                html += '<p>è¯·ç‚¹å‡»"è‡ªåŠ¨ä¿®å¤"æŒ‰é’®</p>';
            }
            html += '</div>';

            resultDiv.innerHTML = html;
        }

        async function fixIssues() {
            const resultDiv = document.getElementById('fixResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>ğŸ”§ ä¿®å¤ä¸­...</p>';

            let html = '<h3>ä¿®å¤æ“ä½œï¼š</h3>';

            // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å¤
            if (diagnosticData.apiOK && diagnosticData.localStorageOK) {
                resultDiv.innerHTML = '<div class="step success"><p>âœ… æ— éœ€ä¿®å¤ï¼Œä¸€åˆ‡æ­£å¸¸ï¼</p></div>';
                return;
            }

            // ä¿®å¤ 1: æ¸…é™¤ç¼“å­˜
            html += '<div class="step">';
            html += '<p>ğŸ—‘ï¸ æ¸…é™¤æœ¬åœ°ç¼“å­˜...</p>';
            localStorage.clear();
            sessionStorage.clear();
            html += '<p>âœ… ç¼“å­˜å·²æ¸…é™¤</p>';
            html += '</div>';

            // ä¿®å¤ 2: æç¤ºé‡æ–°ç™»å½•
            html += '<div class="step warning">';
            html += '<h4>âš ï¸ éœ€è¦é‡æ–°ç™»å½•</h4>';
            html += '<p>ç¼“å­˜å·²æ¸…é™¤ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>';
            html += '<ol style="margin-left: 20px; margin-top: 10px;">';
            html += '<li>ç‚¹å‡»ä¸‹æ–¹"è·³è½¬åˆ°ç™»å½•é¡µ"æŒ‰é’®</li>';
            html += '<li>ä½¿ç”¨ä½ çš„é‚®ç®±å’Œå¯†ç é‡æ–°ç™»å½•</li>';
            html += '<li>ç™»å½•åè¿”å›æ­¤é¡µé¢ï¼Œç‚¹å‡»"éªŒè¯ä¿®å¤"</li>';
            html += '</ol>';
            html += `<button onclick="window.location.href='${FRONTEND_URL}'" style="margin-top: 15px;">
                        ğŸ” è·³è½¬åˆ°ç™»å½•é¡µ
                     </button>`;
            html += '</div>';

            resultDiv.innerHTML = html;
        }

        async function verifyFix() {
            const resultDiv = document.getElementById('verifyResult');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result';
            resultDiv.innerHTML = '<p>âœ… éªŒè¯ä¸­...</p>';

            const user = JSON.parse(localStorage.getItem('user') || 'null');
            const token = localStorage.getItem('token');

            let html = '<h3>éªŒè¯ç»“æœï¼š</h3>';
            const finalResultDiv = document.getElementById('finalResult');

            if (!user || !token) {
                html += '<div class="step error">';
                html += '<p>âŒ æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•</p>';
                html += `<button onclick="window.location.href='${FRONTEND_URL}'">è·³è½¬åˆ°ç™»å½•é¡µ</button>`;
                html += '</div>';
                resultDiv.innerHTML = html;
                return;
            }

            html += '<div class="step">';
            html += `<p>ğŸ“§ ç™»å½•é‚®ç®±: <strong>${user.email}</strong></p>`;
            html += `<p>ğŸ›¡ï¸ å½“å‰è§’è‰²: <strong>${user.role}</strong></p>`;
            html += '</div>';

            if (user.role === 'admin') {
                html += '<div class="step success">';
                html += '<h3>ğŸ‰ æˆåŠŸï¼</h3>';
                html += '<p>ä½ ç°åœ¨æ˜¯ç®¡ç†å‘˜äº†ï¼</p>';
                html += `<button onclick="window.location.href='${FRONTEND_URL}/app'">
                            ğŸš€ è¿›å…¥åº”ç”¨æŸ¥çœ‹ç®¡ç†å‘˜åŠŸèƒ½
                         </button>`;
                html += '</div>';

                finalResultDiv.className = 'success';
                finalResultDiv.style.display = 'block';
                finalResultDiv.innerHTML = `
                    <h2>âœ… ä¿®å¤å®Œæˆï¼</h2>
                    <p style="margin-top: 10px;">ç°åœ¨å»åº”ç”¨ä¸­ï¼Œåœ¨å·¥ä½œç©ºé—´é¡µé¢åº”è¯¥èƒ½çœ‹åˆ° <strong>ğŸ›¡ï¸ ç³»ç»Ÿç®¡ç†</strong> å¡ç‰‡äº†ï¼</p>
                `;
            } else {
                html += '<div class="step error">';
                html += '<h3>âŒ ä»ç„¶ä¸æ˜¯ç®¡ç†å‘˜</h3>';
                html += '<p>è¯·ç¡®ä¿åœ¨ Supabase ä¸­å·²å°†è§’è‰²è®¾ç½®ä¸º admin</p>';
                html += '<p>è®¾ç½®å®Œæˆåï¼Œé€€å‡ºç™»å½•å¹¶é‡æ–°ç™»å½•</p>';
                html += '</div>';

                finalResultDiv.className = 'error';
                finalResultDiv.style.display = 'block';
                finalResultDiv.innerHTML = `
                    <h2>âš ï¸ éœ€è¦æ‰‹åŠ¨æ“ä½œ</h2>
                    <p style="margin-top: 10px;">è¯·ä½¿ç”¨é¡µé¢åº•éƒ¨çš„æ‰‹åŠ¨æ–¹æ³•ä¿®å¤</p>
                `;
            }

            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>

